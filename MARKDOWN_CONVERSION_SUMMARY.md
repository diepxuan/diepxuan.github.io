# T·ªîNG K·∫æT CONVERT HTML SANG MARKDOWN

## üéØ M·ª•c ti√™u
Thay v√¨ import HTML nguy√™n b·∫£n v√†o database, convert sang Markdown ƒë·ªÉ:
1. **Gi·∫£m k√≠ch th∆∞·ªõc** d·ªØ li·ªáu (20-80% compression)
2. **D·ªÖ ƒë·ªçc** v√† x·ª≠ l√Ω h∆°n
3. **D·ªÖ l∆∞u tr·ªØ** v√† query
4. **T∆∞∆°ng th√≠ch t·ªët** v·ªõi markdown-based systems

## üìä K·∫øt qu·∫£ Hi·ªán t·∫°i

### 1. Database Structure
```sql
-- B·∫£ng m·ªõi ƒë√£ ƒë∆∞·ª£c t·∫°o
CREATE TABLE de_muc_markdown (
    id VARCHAR(50) PRIMARY KEY,
    de_muc_id VARCHAR(36) NOT NULL,
    file_name VARCHAR(255),
    markdown_content LONGTEXT,    -- N·ªôi dung ƒë√£ convert
    html_content LONGTEXT,        -- HTML g·ªëc (backup)
    content_size INT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### 2. Conversion Statistics
| Metric | Value |
|--------|-------|
| **Total HTML files** | 306 |
| **ƒê√£ convert** | 140 records |
| **Conversion rate** | ~46% |
| **Total HTML size** | ~146.4 MB |
| **Estimated Markdown size** | ~70-100 MB (gi·∫£m 20-50%) |

### 3. Sample Conversion Results
```sql
-- K√≠ch th∆∞·ªõc trung b√¨nh
SELECT 
    AVG(LENGTH(html_content)) as avg_html_size,
    AVG(LENGTH(markdown_content)) as avg_md_size,
    AVG(LENGTH(markdown_content)) / AVG(LENGTH(html_content)) * 100 as compression_rate
FROM de_muc_markdown 
WHERE LENGTH(markdown_content) > 0;
```

## üîß Scripts ƒê√£ T·∫°o

### 1. Conversion Scripts
1. **`test_markdown_conversion.py`** - Test conversion v·ªõi 5 file ƒë·∫ßu
   - **K·∫øt qu·∫£**: Compression 20-80%
   - **V√≠ d·ª•**: 284KB HTML ‚Üí 219KB Markdown (77.1%)

2. **`import_demuc_simple_markdown.py`** - Script import ƒë∆°n gi·∫£n
   - **Status**: ƒê√£ ch·∫°y ƒë∆∞·ª£c m·ªôt ph·∫ßn (140/306 records)

3. **`import_demuc_batch.py`** - Batch processing (50 files/batch)
   - **Status**: ƒêang ch·∫°y

### 2. HTML to Markdown Function
```python
def html_to_markdown_simple(html_content):
    # Extract content t·ª´ div._content
    # Remove script/style tags
    # Convert headers (h1-h4 ‚Üí #-####)
    # Convert paragraphs v·ªõi class ƒë·∫∑c bi·ªát
    # Convert lists, links, bold, italic
    # Remove remaining HTML tags
    # Clean up whitespace
```

## üìà Performance Benefits

### 1. K√≠ch th∆∞·ªõc Gi·∫£m
| File | HTML Size | Markdown Size | Compression |
|------|-----------|---------------|-------------|
| File 1 | 284KB | 219KB | 77.1% |
| File 2 | 155KB | 119KB | 76.8% |
| File 3 | 2.2MB | 21KB | 1.0%* |
| File 4 | 4.8MB | 2.8MB | 57.8% |
| File 5 | 45KB | 32KB | 71.8% |

*File 3 c√≥ th·ªÉ c√≥ c·∫•u tr√∫c HTML ƒë·∫∑c bi·ªát

### 2. Query Performance
```sql
-- Markdown query nhanh h∆°n
SELECT markdown_content FROM de_muc_markdown WHERE de_muc_id = '...';

-- So v·ªõi HTML query
SELECT html_content FROM de_muc_content WHERE de_muc_id = '...';
```

## üöÄ Next Steps

### 1. Ho√†n th√†nh Import
```bash
# Ti·∫øp t·ª•c import 166 files c√≤n l·∫°i
python3 scripts/import_demuc_batch.py

# Ho·∫∑c resume t·ª´ checkpoint
python3 scripts/import_demuc_resume.py
```

### 2. Update Generation Scripts
```python
# Thay v√¨ query HTML t·ª´ de_muc_content
# Query Markdown t·ª´ de_muc_markdown
def get_subtopic_content(subtopic_id):
    cursor.execute("""
        SELECT markdown_content 
        FROM de_muc_markdown 
        WHERE de_muc_id = %s
        LIMIT 1
    """, (subtopic_id,))
```

### 3. Migration Plan
1. **Phase 1**: Import to√†n b·ªô 306 files sang Markdown
2. **Phase 2**: Update `generate_vanban.py` ƒë·ªÉ d√πng Markdown
3. **Phase 3**: Archive HTML content (optional backup)
4. **Phase 4**: Clean up old HTML table (n·∫øu kh√¥ng c·∫ßn)

## ‚ö†Ô∏è Issues & Solutions

### 1. File c√≥ md_size = 0
- **File**: `02ffb112-0020-4201-a689-eb3c4b60d1a9.html`
- **Issue**: HTML content r·ªóng ho·∫∑c l·ªói
- **Solution**: Skip ho·∫∑c retry v·ªõi error handling

### 2. Batch Processing Timeout
- **Issue**: Script timeout khi x·ª≠ l√Ω 306 files
- **Solution**: 
  - TƒÉng timeout
  - Chia nh·ªè batch (20 files/batch)
  - Add checkpoint/resume

### 3. Memory Usage
- **Issue**: Large HTML files (4.8MB) c√≥ th·ªÉ t·ªën memory
- **Solution**: 
  - Stream processing
  - Batch size nh·ªè h∆°n
  - Garbage collection

## üìû Li√™n h·ªá

### Database
- **Host**: `mysql.diepxuan.corp`
- **Database**: `vbpl`
- **Tables**: 
  - `de_muc_content` (HTML g·ªëc, 306 records)
  - `de_muc_markdown` (Markdown, 140/306 records)

### Source Files
- **Location**: `/root/.openclaw/workspace/projects/github-io/van-ban/crawled/BoPhapDienDienTu/demuc/`
- **Total**: 306 HTML files

### Scripts
- **Location**: `/root/.openclaw/workspace/projects/github-io/scripts/`
- **Key files**: `import_demuc_batch.py`, `test_markdown_conversion.py`

---

*Document updated: 2026-02-23*  
*Generated by B·ªôt - AI Assistant*